# Бэкенд для проекта FoodDelivery

## Важное ограничение. Одновременно над базой работать не получится, работать
## будем итерационно, по очереди: один взялся делать какие-то методы, остальные 
## его ждут, после того как изменения базы залиты на гитхаб - следующий может 
## приступать к своей части.

### 1 Подготовка
    1.1 Клонируем себе проект
    1.2 Устанавливаем Vapor командой в терминале `brew install vapor`
    1.3 Устанавлием Docker командой в терминале `brew install docker`, а также устанавлиаваем
    декстопное приложение с официального сайта Docker
    1.4 Устанавливаем декстопное приложение DBeaver(для просмотра БД) с официального сайта DBeaver
    1.5 Устанавливаем декстопное приложение Postman с официального сайта Postman для отправки запросов
    
### 2 Запуск БД
    2.1 Открываем в терминале директорию нашего проекта FoodDeliveryBackend
    2.2 Выполняем команду `docker-compose up db`
    2.3 Если в папке с проектом уже лежал файл `fd_database_dump.sql` то все изменения из этого файла подтянутся в базу

### 3 Подключение к БД
    3.1 Запускаем DBeaver, при необходимости доустанавливаем драйвера, которые он предложит
    3.2 В верхнем левов углу нажимаем иконку штепселя со знаком `+`, выбираем PostgresSQL
    3.3 Заполняем поля формы База данных: fd_database, Пользователь: fd_username, Пароль: fd_password,
    и нажимаем Finish.
    3.4 Раскрываем иерархию появившегося подключения вплоть до таблиц, там будут таблицы с данными и таблицы миграции Fluent.
    Если же на момент создания контейнера для БД(п 2.2) файла дапма данных в проекте не было - то таблиц не будет.
    
### 4 (ОПЦИОНАЛЬНО) На случай если после пунктов 2 и 3 в БД все еще пусто несмотр на наличие файла дампа данных
    Восстановление данных из файла 'fd_database_dump.sql'
    4.1 При всех открытых выше программах открываем в терминале директорию нашего проекта FoodDeliveryBackend
    4.2 Вводим команду в терминале: cat fd_database_dump.sql | docker-compose exec -T db psql -U fd_username -d fd_database
    4.3 Возвращаемся в DBeaver, через сочетание клавиш fn + F5 пытаемся обновить подключение. 
    4.4 Если не сработало, то закрываем соединение с БД, потом повторяем пункты 3.2 и 3.3
    4.5 В итоге в иерархии папок нашего подключения должны появиться сами таблицы с данными и таблицы миграции Fluent.
    
### 5 Запуск самого бэкендного проекта Vapor
    5.1 Открываем файл Package.swift, таргет - MacOs, далее Сmd + R 
    5.2 После запуска в панеле логирования должна появиться информация о подключении к http://127.0.0.1:8080
    
### 6 Работаем над своими запросами используя Xcode, Postman, DBeaver.

### 7 По окончанию работ над базой нужно заменить файл 'fd_database_dump.sql' на новый
    7.1 Удаляем имеющийся файл 'fd_database_dump.sql'
    7.1 Для этого открываем в терминале директорию нашего проекта FoodDeliveryBackend
    7.2 Вводим команду в терминале: docker-compose exec db pg_dump -U fd_username -d fd_database > fd_database_dump.sql и получаем файл бэкапа базы
    
### 8 Допонлняем ниже набор работающих методов, коммитим и пушим изменения

## В данный момент после подгрузки бэкапа базы доступны для работы следующие методы:
    1. POST: http://127.0.0.1:8080/categories - служебный метод для добавления категорий
    2. GET: http://127.0.0.1:8080/categories - метод приложения FoodDelivery для получения категорий
    
В последующие разы, для загрузки бэкапа достоточно запустить докер-контейнер, в DBeaver выполнить подключение к БД
и удалить таблицы с данными и таблицы с миграциями. После этого выполнить все действия раздела 4.
Если таблицы не удалить - бэкап не встанет.
    
Возможные проблемы:
1. При запуске Докер-контейнера с базой данных - запуска так и не происходит. 
Это значит, что скорее всего необходимый докеру порт 5432 скорее всего занят каким-то процессом. 
Для решения проблемы нужно проделать следующее в терминале
```shell
sudo lsof -i:5432 - потребует ввести пароль а после покажется PID(идентификатор процесса), который у нас занимает порт, например PID 67186
далее используем команду
sudo kill 67186 - эта команда прекратит данный процес
и снова
sudo lsof -i:5432 - терминал ничего не ответит и передаст управление, что значит, что порт очистился
```
После этого нужно перезапустить докер и запустить заново докер-контейнер с БД.
    
